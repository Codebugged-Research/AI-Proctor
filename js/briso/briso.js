const lib_version="2.0.0",brisoEventName="briso-alert",brisoUserLSKeyName="briso_user";var state={initialized:!1,userRegistered:!1,severConnected:!1,clientVerified:!1,isMonitoring:!1,isPaused:!1,apiId:"",contextId:"",monitoringId:null,user:{user_id:"",distinguisher_id:""}},validations={isMicAvailable:!1,isCameraAvailable:!1,fakeFeedDetected:!1},references={video_ref:null,canvas_ref:null,canvas_ctx_ref:null,monitoring_process:{face_monitoring_process:null,speech_monitoring_process:null},brisoEventListener:null},settings={mediaToMonitor:{audio:!0,video:!0},videoElementId:"video",videoElementWidth:640,videoElementHeight:480,apiId:"",contextId:"",userDetails:{userId:"",distinguisher_id:""},debug:!0,brisoServer:"http://127.0.0.1:5000",monitoring_interval:5e3};function configure(e){reset(),settings=Object.assign({},settings,e),state.apiId=settings.apiId,state.contextId=settings.contextId,state.user.user_id=settings.userDetails.userId,state.user.distinguisher_id=settings.userDetails.distinguisher_id,references.video_ref=document.getElementById(settings.videoElementId),references.canvas_ref=document.createElement("canvas"),references.canvas_ctx_ref=references.canvas_ref.getContext("2d"),references.canvas_ref.width=settings.videoElementWidth,references.canvas_ref.height=settings.videoElementHeight}function reset(){state.initialized=!1,state.userRegistered=!1,state.isMonitoring=!1,state.isPaused=!1,state.severConnected=!1,state.clientVerified=!1,state.apiId="",state.monitoringId=null,state.user={user_id:"",distinguisher_id:""},state.contextId="",validations.isMicAvailable=!1,validations.isCameraAvailable=!1,validations.fakeFeedDetected=!1,references.video_ref=null,references.monitoring_process={face_monitoring_process:null,speech_monitoring_process:null},references.brisoEventListener=null,settings.mediaToMonitor={audio:!0,video:!0},settings.videoElementId="video",settings.videoElementHeight=640,settings.videoElementWidth=480,settings.apiId="",settings.contextId="",settings.userDetails={userId:"",distinguisher_id:""},settings.debug=!1,settings.brisoServer="http://127.0.0.1:5000",settings.monitoring_interval=1e4}function to_blob(e){for(var t=atob(e.split(",")[1]),i=e.split(",")[0].split(":")[1].split(";")[0],n=new ArrayBuffer(t.length),o=new Uint8Array(n),s=0;s<t.length;s++)o[s]=t.charCodeAt(s);return new Blob([n],{type:i})}function log(e,t){settings.debug&&(void 0===t?console.log(e):console.log(e,t))}function get_time(){time=new Date;let e=time.getHours(),t=time.getMinutes(),i=time.getSeconds();return e+":"+(t=t<10?"0"+t:t)+":"+(i=i<10?"0"+i:i)}function generateUUID(){var e=(new Date).getTime(),t=performance&&performance.now&&1e3*performance.now()||0;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(i){var n=16*Math.random();return e>0?(n=(e+n)%16|0,e=Math.floor(e/16)):(n=(t+n)%16|0,t=Math.floor(t/16)),("x"===i?n:3&n|8).toString(16)})}function detectIfMobileDevice(){var e=!1;return(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4)))&&(e=!0),e}var validator=function(){"use strict";var e={};return e.initialChecks=function(){!function(){let e=navigator.mediaDevices;if(!e)throw"localhost"===window.location.hostname&&console.log("Follow this link to provide access to devices: https://medium.com/@Carmichaelize/enabling-the-microphone-camera-in-chrome-for-local-unsecure-origins-9c90c3149339"),"Briso: Either the connection is not secure or access to media devices is not provided";e.enumerateDevices().then(e=>{e.forEach(function(e){if(e.label.toLowerCase().includes("fake"))throw state.fakeFeedDetected=!0,brisoEventEmitter(BrisoEvents.FAKE_FEED_DETECTED),"Briso: Fake Feed Detected"})}),e.getUserMedia({video:!0}).then(e=>{state.isCameraAvailable=!0}).catch(()=>{throw"Briso: Camera permission is not available."}),e.getUserMedia({audio:!0}).then(e=>{state.isMicAvailable=!0}).catch(()=>{throw"Briso: Mic permission is not available."})}(),function(){if(null===document.getElementById(settings.videoElementId))throw"Invalid video element id, cannot find any video element on the page"}()},e}(),eventsQueue=[];const BrisoEvents={MONITORING_START:{name:"MONITORING_START",type:"Info",description:"Monitoring has been started"},MONITORING_PAUSED:{name:"MONITORING_PAUSED",type:"Info",description:"Monitoring has been paused"},MONITORING_RESUMED:{name:"MONITORING_RESUMED",type:"Info",description:"Monitoring has been resumed"},MONITORING_STOPPED:{name:"MONITORING_STOPPED",type:"Info",description:"Monitoring has been stopped"},CAMERA_ERROR:{name:"CAMERA_ERROR",type:"Alert",description:"No feed detected, either the camera isn't working or is tampered with"},CAMERA_TAMPERED:{name:"CAMERA_TAMPERED",type:"Alert",description:"Camera seems to be tampered with."},MIC_ERROR:{name:"MIC_ERROR",type:"Alert",description:"Can't record audio, speech recognition failed."},NO_PERSON_IN_FRAME:{name:"NO_PERSON_IN_FRAME",type:"Alert",description:"No person detected in video feed"},MULTIPLE_DETECTIONS:{name:"MULTIPLE_DETECTIONS",type:"Alert",description:"Multiple people detected in the feed"},FAKE_ALERT:{name:"FAKE_ALERT",type:"Alert",description:"The feed isn't live"},UNKNOWN_PERSON:{name:"UNKNOWN_PERSON",type:"Alert",description:"Could not clearly detect the face or unknown person detected"},UNABLE_TO_SETUP_USER:{name:"UNABLE_TO_SETUP_USER",type:"Error",description:"There was a problem while setting up user for detection"},IMAGE_DOWNLOAD_ERROR:{name:"IMAGE_DOWNLOAD_ERROR",type:"Error",description:"Can't Download Image"},PERSON_NOT_FOUND:{name:"PERSON_NOT_FOUND",type:"Error",description:"Can't Find The User In The Database"},UNREAL_PERSON_DETECTED:{name:"UNREAL_PERSON_DETECTED",type:"Error",description:"The detected feed might not be live.The feed may be a fake representation of the person"}};async function brisoEventEmitter(e){var t=new CustomEvent("briso-alert",{detail:{name:e.name,type:e.type,message:e.description,timestamp:Date.now(),source:"briso",contextId:state.contextId,userId:state.user.user_id}}),i=!0;if(eventsQueue.length>3&&(eventsQueue=[]),eventsQueue.push(e.name),eventsQueue.length>0){const e=eventsQueue.filter(e=>e==BrisoEvents.UNREAL_PERSON_DETECTED.name).length;e>1&&e===eventsQueue.length&&(i=!1)}i&&document.dispatchEvent(t)}function brisoEventHandler(e){log("Brio event: ",e.detail)}Object.freeze(BrisoEvents);var server_connect=function(){var e=null;let t={};return t.connect=function(){if(null!=e&&e.connected)log("Already connected to the server");else{var t={reconnectionAttempts:20,reconnectionDelay:7e3,reconnectionDelayMax:12e3,timeout:6e4,forceNew:!0,transportOptions:{origins:"*",upgrade:!0,polling:{extraHeaders:{"x-briso-version":"2.0.0","x-api-id":state.apiId,"x-context-id":settings.contextId,"x-distinguisher-id":state.user.distinguisher_id,"x-user-id":state.user.user_id,"x-monitoring-id":state.monitoringId}}}};(e=io.connect(settings.brisoServer,t)).on("connect",e=>{log("Briso: Server Connected")}),e.on("connected",e=>{state.severConnected=!0,state.clientVerified=!0,state.userRegistered=!0,log("Client is authorized for connection and user has been setup.."),document.dispatchEvent(new CustomEvent("briso-backend-connected"))}),e.on("connect_error",function(){console.error("Briso: Connection with server cannot be established"),state.severConnected=!1,state.isMonitoring&&(!0===settings.mediaToMonitor.video&&face_ops.pauseMonitoring(),!0===settings.mediaToMonitor.audio&&speech_ops.pauseMonitoring())}),e.on("unauthorized",e=>{console.log("Briso: "+e),state.clientVerified=!1,state.userRegistered=!1,$.fn.briso().stopMonitoring()}),e.on("reconnect",t=>{console.log("Briso: Reconnected with the server, skid: "+e.id),state.severConnected=!0,!state.isPaused&&state.isMonitoring&&(!0===settings.mediaToMonitor.video&&face_ops.resumeMonitoring(),!0===settings.mediaToMonitor.audio&&speech_ops.resumeMonitoring())}),e.on("disconnect",t=>{"io server disconnect"===t&&e.connect(),state.severConnected=!1}),e.on("briso-alert",e=>{brisoEventEmitter(BrisoEvents[e.message])}),e.on("error",e=>{e.hasOwnProperty("message")?log("Briso: Server Error : ",e.message):log("Briso: Server Error : ",e)})}},t.closeConnection=function(){null!==e&&(e.close(),e=null,state.severConnected=!1,log("Briso: Server disconnected"))},t.getConnection=function(){return e},t}(),face_ops=function(){let e={};function t(){0!==references.video_ref.readyState?(references.canvas_ctx_ref.drawImage(references.video_ref,0,0,references.canvas_ref.width,references.canvas_ref.height),frame=references.canvas_ref.toDataURL("image/jpeg"),frame=to_blob(frame),log("Briso: Sending feed to server to monitor with skid - "+server_connect.getConnection().id),void 0!==server_connect.getConnection().id&&server_connect.getConnection().emit("monitor",{monitoring_id:state.monitoringId,frame:frame})):brisoEventEmitter(BrisoEvents.CAMERA_ERROR)}return e.initialize=function(e,t){},e.startMonitoring=function(){return references.monitoring_process.face_monitoring_process=setInterval(t,settings.monitoring_interval),state.isMonitoring=!0,state.isPaused=!1,Promise.resolve(!0)},e.pauseMonitoring=function(){clearInterval(references.monitoring_process.face_monitoring_process),state.isPaused=!0},e.resumeMonitoring=function(){state.isMonitoring&&this.startMonitoring()},e.stopMonitoring=function(){clearInterval(references.monitoring_process.face_monitoring_process),state.isPaused=!0,state.isMonitoring=!1},e}(),speech_ops=function(){let e={},t=null;return e.initialize=async function(e,i){var n=n||webkitSpeechRecognition;(t=new n).continuous=!1,t.lang="en-in",t.interimResults=!0,t.maxAlternatives=0},e.startMonitoring=async function(){return function(){log("Briso: Started monitoring sounds");var e="";try{t.start()}catch(e){log("Briso: Speech Detection already in progress")}t.onspeechstart=function(){start_time=get_time(),log("Briso: Speech has started")},t.onspeechend=function(e){end_time=get_time(),log("Briso: Speech has ended")},t.onresult=function(t){end_time=get_time(),e=`[${start_time}] - [${end_time}] [Text] - ${t.results[t.resultIndex][0].transcript}`},t.onend=function(){""!==e&&(log("Briso: Recognized text:"+e),null!==server_connect.getConnection()&&void 0!==server_connect.getConnection().id&&(server_connect.getConnection().emit("voice_alert",{monitoring_id:state.monitoringId,message:e}),brisoEventEmitter({name:"SPEECH_DETECTED",type:"Alert",description:e}))),e="",state.isPaused&&state.isMonitoring||t.start()}}(),Promise.resolve(!0)},e.pauseMonitoring=function(){t.stop()},e.resumeMonitoring=function(){this.startMonitoring()},e.stopMonitoring=function(){null!==t&&t.abort()},e}();!function(e,t){this.$;e.fn.briso=function(e){return{init:function(e){if(console.log("Briso: Initializing Version : 2.0.0"),void 0===e.userDetails)return Promise.reject("User with empty details cannot be setup");if(""===e.userDetails.user_id||""===e.userDetails.distinguisher_id&&void 0===e.userDetails.distinguisher_id)return Promise.reject("User cannot be setup with empty user_id or empty distinguisher_id");if(configure(e),references.brisoEventListener=t.addEventListener("briso-alert",function(e){brisoEventHandler(e)}),validator.initialChecks(),validations.fakeFeedDetected)throw"Briso: Fake Feed Detected, cannot initialize";state.monitoringId=generateUUID(),log("Briso: The monitoring id for this session is - "+state.monitoringId),state.initialized||state.userRegistered?console.log("Briso: Already initialized."):(server_connect.connect(),t.addEventListener("briso-backend-connected",function(e){state.initialized||(!0===settings.mediaToMonitor.video&&face_ops.initialize(),detectIfMobileDevice()&&(console.log("Briso: Mobile device detected, not initializing sound checks"),settings.mediaToMonitor.audio=!1),!0===settings.mediaToMonitor.audio&&speech_ops.initialize(),state.initialized=!0,console.log("Briso: Initialized. Monitoring video: "+settings.mediaToMonitor.video+", audio: "+settings.mediaToMonitor.audio),t.dispatchEvent(new CustomEvent("briso-server-connected")))}))},startMonitoring:function(){if(!state.initialized||!state.userRegistered)throw"Briso has not been initialized or user to monitor has not been registered";console.log("Briso: Starting Monitoring"),!0===settings.mediaToMonitor.video&&face_ops.startMonitoring(),!0===settings.mediaToMonitor.audio&&speech_ops.startMonitoring(),brisoEventEmitter(BrisoEvents.MONITORING_START)},pauseMonitoring:function(e=120){state.isMonitoring?(console.log("Briso: Pausing Monitoring"),server_connect.getConnection().emit("pause_monitoring"),!0===settings.mediaToMonitor.video&&face_ops.pauseMonitoring(),!0===settings.mediaToMonitor.audio&&speech_ops.pauseMonitoring(),brisoEventEmitter(BrisoEvents.MONITORING_PAUSED),setTimeout(this.resumeMonitoring,1e3*e)):log("Monitoring is not in progress, cannot pause")},resumeMonitoring:function(){state.isPaused&&(console.log("Briso: Resuming Monitoring"),!0===settings.mediaToMonitor.video&&face_ops.resumeMonitoring(),!0===settings.mediaToMonitor.audio&&speech_ops.resumeMonitoring(),brisoEventEmitter(BrisoEvents.MONITORING_RESUMED))},stopMonitoring:function(){console.log("Briso: Stopping Monitoring"),state.isMonitoring&&(server_connect.getConnection().emit("stop_monitoring"),!0===settings.mediaToMonitor.video&&face_ops.stopMonitoring(),!0===settings.mediaToMonitor.audio&&speech_ops.stopMonitoring(),brisoEventEmitter(BrisoEvents.MONITORING_STOPPED),t.removeEventListener("briso-alert",references.brisoEventListener)),server_connect.closeConnection(),reset()},getMonitoringStatus:function(){return state.isPaused?"Briso: Paused":state.isMonitoring?"Briso: Monitoring Active":"Briso: Not Monitoring"}}}}(jQuery,document),function(){if("function"==typeof window.CustomEvent)return!1;function e(e,t){t=t||{bubbles:!1,cancelable:!1,detail:void 0};var i=document.createEvent("CustomEvent");return i.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),i}e.prototype=window.Event.prototype,window.CustomEvent=e}();
